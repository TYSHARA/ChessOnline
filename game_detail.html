<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game Detail</title>

    <!-- Include Chessboard.js and Chess.js from a CDN (Content Delivery Network) -->
    <link rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
      integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
      crossorigin="anonymous">
      
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>

    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
        crossorigin="anonymous"></script>
        
   
</head>



<body>
    <h1>Chess Game Detail</h1>

    <div>
        <!-- Display Player Information -->
        <p>Player 1: {{ game.player1.username }}</p>
        <p>Player 2: {{ game.player2.username }}</p>
    </div>


    <div id="myBoard" style="width: 45%"></div>
    <button id="startBtn">Start Position</button>
    
    <label>Status:</label>
    <div id="status"></div>
	

    <!-- Form for Making Moves -->
    <form method="post" action="{% url 'game-detail' game_id=game.id %}">
        {% csrf_token %}
        {{ make_move_form }}
        <button type="submit">Make Move</button>
    </form>

    <!-- Display Moves -->
    <h2>Moves</h2>
    <ul>
        {% for move in moves %}
            <li>{{ move }}</li>
        {% endfor %}
    </ul>
    
    
   
   
 
   
    //for the importation of chess.js so that we make move validations
    <script type="module"> 
    
        import { Chess } from 'https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.6/+esm' 
      	
	var game = new Chess()
	var $status = $('#status')
	var whiteSquareGrey = '#a9a9a9'
	var blackSquareGrey = '#4d5459'

	function removeGreySquares () {
	  $('#myBoard .square-55d63').css('background', '')
	}

	function greySquare (square) {
	  var $square = $('#myBoard .square-' + square)

	  var background = whiteSquareGrey
	  if ($square.hasClass('black-3c85d')) {
	    background = blackSquareGrey
	  }

	  $square.css('background', background)
	}

	
	function onMouseoverSquare (square, piece) {
	  // get list of possible moves for this square
	  var moves = game.moves({
	    square: square,
	    verbose: true
	  })

	  // exit if there are no moves available for this square
	  if (moves.length === 0) return

	  // highlight the square they moused over
	  greySquare(square)

	  // highlight the possible squares for this piece
	  for (var i = 0; i < moves.length; i++) {
	    greySquare(moves[i].to)
	  }
	}
	
	
	function onMouseoutSquare (square, piece) {
	  removeGreySquares()
	}


	function onDragStart (source, piece, position, orientation) {
	  // do not pick up pieces if the game is over
	  if (game.isGameOver()) return false

	  // only pick up pieces for the side to move
	  if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
	      (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
	    return false
	  }
	}

	function onDrop (source, target) {
	  // see if the move is legal
	  var move = game.move({
	    from: source,
	    to: target,
	    promotion: 'q' // NOTE: always promote to a queen for example simplicity
	  })

	  // illegal move
	  if (move === null) { 
	  return 'snapback' 
	  }

	  updateStatus()
	}

	// update the board position after the piece snap
	// for castling, en passant, pawn promotion
	function onSnapEnd () {
	  board.position(game.fen())
	}

	function updateStatus () {
	  var status = ''

	  var moveColor = 'White'
	  if (game.turn() === 'b') {
	    moveColor = 'Black'
	  }

	  // checkmate?
	  if (game.isCheckmate()) {
	    status = 'Game over, ' + moveColor + ' is in checkmate.'
	  }

	  // draw?
	  else if (game.isDraw()) {
	    status = 'Game over, drawn position'
	  }

	  // game still on
	  else {
	    status = moveColor + ' to move'

	    // check?
	    if (game.inCheck()) {
	      status += ', ' + moveColor + ' is in check'
	    }
	  }

	  $status.html(status)
	}
	
	
	
	
	
        // JavaScript code to initialize the chessboard
        function pieceTheme (piece) {
        
	  //Добавляем все белые фигуры на доску
	  if (piece.search(/w/) !== -1) {
	    return 'images/pieces/' + piece + '.svg'
	  }

	  //for black pieces
	  return 'images/pieces/' + piece + '.svg'
	}


	var config = {
		  orientation: 'black',
		  draggable: true,
  		  dropOffBoard: 'snapback',
  		  pieceTheme: pieceTheme,
		  position: 'start',
		  moveSpeed: 'slow',
		  snapbackSpeed: 500,
		  onDragStart: onDragStart,
		  onDrop: onDrop,
		  onSnapEnd: onSnapEnd,
		  onMouseoutSquare: onMouseoutSquare,
  		  onMouseoverSquare: onMouseoverSquare,
		  snapSpeed: 100,
		  showNotation: false
		  
		}
		
	var board = Chessboard('myBoard', config)
	
	$('#startBtn').on('click', board.start)
       
        
    </script>
    
</body>
</html>
